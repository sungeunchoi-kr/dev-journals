# Code Trace
## Startup

### Configuration file:
Reads `C:\Users\{{user}}\AppData\Roaming\obs-studio\basic\profiles\Untitled\basic.ini`. Generated by a call to `obs-app.cpp::GetConfigPath()`; the "obs-studio/basic/profiles" is hard-coded.

If config file does not exist, `OBSBasic::OBSInit() -> OBSBasic::InitBasicConfig -> DefaultsOBSBasic::InitBasicConfigDefaults()` is called.
## Recording and Save to File

1. `OBSBasic::StartRecording()`
    - `outputHandler->StartRecording()`
        - where `outputHandler` is `BasicOutputHandler` in `window-basic-main-outputs.hpp`.
          `SimpleOutput` is a subclass of `BasicOutputHandler`.
2. `SimpleOutput::StartRecording()`
    1. `UpdateRecording()`
        - `UpdateRecordingSettings()`
            - `UpdateRecordingSettings_nvenc()`
            ```
            OBSDataAutoRelease settings = obs_data_create();
	        obs_data_set_string(settings, "rate_control", "CQP");
	        obs_data_set_string(settings, "profile", "high");
	        obs_data_set_string(settings, "preset", "hq");
	        obs_data_set_int(settings, "cqp", cqp);
	        obs_encoder_update(videoRecording, settings);
            ```
        - `SetupOutputs()`
            - `Update()`
                - `obs_encoder_update(videoStreaming, videoSettings);`
            - `obs_encoder_set_video(videoRecording, obs_get_video());`
            - If you call obs_get_video(), the video's info you get (fps, dimension, etc) are set in `Settings > Video` tab.
        - `obs_output_set_video_encoder(fileOutput, videoRecording);`, `obs_output_set_audio_encoder(fileOutput, aacRecording, 0);`
    2. `ConfigureRecording()`
        - (mainly set output file path, etc.)
        - `obs_output_update(fileOutput, settings);`
    3. `obs_output_start(fileOutput)`


### SimpleOutput class
in `window-basic-main-outputs.cpp`.

Constructor:
- reads `main->Config()` and sets various encoders.
- calls `fileOutput = obs_output_create("ffmpeg_muxer", "simple_file_output", nullptr, nullptr);` where `fileOutput` is `OBSOutputAutoRelease`.


# Questions:
## Where do you get the list of display and window devices?
```
window-basic-main.cpp:
OBSBasic::AddProjectorMenuMonitors()
```

## What's the call stack when display is switched?
(e.g. switch screen recording monitor from display 1 to display 2)
```
Update screen capture display call stack:
- obs_source_update(obs_source_t *source, obs_data_t *settings)
- void UpdateSourceComboToolbarValue(QComboBox *combo, OBSSource source, int idx,
				   const char *prop_name, bool is_int) @ context-bar-controls.cpp
- void ComboSelectToolbar::on_device_currentIndexChanged(int idx)
```

# Appendix 
### Relevant basicConfig
```cpp
OBSBasic::InitBasicConfigDefaults:
config_set_default_uint(basicConfig, "Video", "BaseCX", cx);
config_set_default_uint(basicConfig, "Video", "BaseCY", cy);

config_set_default_string(basicConfig, "Output", "FilenameFormatting",
    "%CCYY-%MM-%DD %hh-%mm-%ss");

config_set_default_uint(basicConfig, "Video", "OutputCX", scale_cx);
config_set_default_uint(basicConfig, "Video", "OutputCY", scale_cy);

// selects between the dropdown values "Common FPS Values", "Integer FPS Values", and "Fractional FPS Values".
config_set_default_uint(basicConfig, "Video", "FPSType", 0);
config_set_default_string(basicConfig, "Video", "FPSCommon", "30");
config_set_default_uint(basicConfig, "Video", "FPSInt", 30);
config_set_default_uint(basicConfig, "Video", "FPSNum", 30);
config_set_default_uint(basicConfig, "Video", "FPSDen", 1);
config_set_default_string(basicConfig, "Video", "ScaleType", "bicubic");
config_set_default_string(basicConfig, "Video", "ColorFormat", "NV12");
config_set_default_string(basicConfig, "Video", "ColorSpace", "709");
config_set_default_string(basicConfig, "Video", "ColorRange",
    "Partial");
config_set_default_uint(basicConfig, "Video", "SdrWhiteLevel", 300);
config_set_default_uint(basicConfig, "Video", "HdrNominalPeakLevel",
    1000);


```

## Other Notes
```
called from obs-source.c::obs_source_create():

duplicator-monitor-capture.c:
static void duplicator_capture_defaults(obs_data_t *settings)
{
	obs_data_set_default_int(settings, "method", METHOD_AUTO);
	obs_data_set_default_int(settings, "monitor", 0);
	obs_data_set_default_int(settings, "monitor_wgc", 0);
	obs_data_set_default_bool(settings, "capture_cursor", true);
}
```

This is called when screen capture display is updated, but it reads the setting; still don't know where it's being set.
```
duplicator-monitor-capture.c:
static inline void update_settings(struct duplicator_capture *capture,
				   obs_data_t *settings)

```

There's a plugin called "win-capture".
